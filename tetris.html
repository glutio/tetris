<html>
<head>
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<style>
table {
   margin:auto;
   border-spacing: 0px;
}  
v *{
 border: 1px solid red;
}
#wrap {
    display:table;
    margin:auto;
}
#control {
    margin:auto;
    text-align:center;
}
#well td {
    width: 12px;
    height: 12px;
    border-width: 0.5;
    background-color: #ffdae1;
    border-style: outset;
}

 #well td.nonempty {
    background-color: green;
 }
 #well td.nonempty.shape {
    background-color: blue;

 }
 
 #well td.nonempty[data-color="B"]
 {
  background-color:blue;
 }
 #well td.nonempty[data-color="I"]
 {
  background-color:red;
 }
 #well td.nonempty[data-color="T"]
 {
  background-color:darkorange;
 }
 #well td.nonempty[data-color="LL"]
 {
  background-color:gray;
 }

 #well td.nonempty[data-color="RL"]
 {
  background-color:magenta;
 }
 #well td.nonempty[data-color="LS"]
 {
  background-color:darkcyan;
 }
 #well td.nonempty[data-color="RS"]
 {
   background-color:green;
 }

 #control button {
    margin-left:10px;
    margin-right:10px;
    margin-top:10px;
    width:50px;
    height: 50px;
 }
 #again {
    position:absolute;
    top:10%;
    width:100%;    
    display:none;
 }
 #again button {
    min-height:60px;   
    max-width:130px;
    overflow:hidden;
 }
</style>
</head>
<body>
<div id="wrap">
<table id="well" tabindex="1" ></table>
<table id="again">
  <tr><td><button>Again!</button></td></tr>
</table>
</div>
<table id="control">
  <tr>
    <td><button id="left">Left</button></td>
    <td><button id="rotate">Rot</button></td>
    <td><button id="right">Right</button></td>
  </tr>
  <tr>
    <td colspan="3"><button id="drop">Drop</button></td>
  </tr>
</table>               
<!--<script src="tetris.js" /></script> -->
<script>
var shp=0;
var r=0;
var pt = { x:0, y:0 };
var spd = 800;            
var timer;
var score = 0;
var shapes = {
B:[{org:{x:0,y:0}, s:`
**
**`}],
I:[{org:{x:1,y:0}, s: `
****`},{org:{x:0,y:1}, s:`
*
*
*
*`
}],
LL:[{org:{x:0,y:0}, s:`
 *
 *
**`},{org:{x:0,y:0}, s:`
*
***`},{org:{x:0,y:0}, s:`
**
*
*`},{org:{x:0,y:0}, s:`
***
  *`
}],
RL:[{org:{x:0,y:0}, s:`
*
*
**`},{org:{x:0,y:0}, s:`
***
*`},{org:{x:0,y:0}, s:`
**
 *
 *`},{org:{x:0,y:0}, s:`
  *
***`
}],
T:[{org:{x:0,y:-1}, s:`
***
 *`},{org:{x:0,y:0}, s:`
 *
**
 *`},{org:{x:0,y:0}, s:`
 *
***`},{org:{x:-1,y:0}, s:`
*
**
*`}],
LS:[{org:{x:0,y:0}, s:`
*
**
 *`},{org:{x:0,y:0}, s:`
 **
**`}],
RS:[{org:{x:0,y:0}, s:`
 *
**
*`},{org:{x:0,y:0}, s:`
**
 **`}]
};

function makeShapes()
{
   for(var p=0; p<Object.keys(shapes).length; p++)
   {
      var key = Object.keys(shapes)[p]; 
      for(var s=0; s<shapes[key].length; s++)
            shapes[key][s].s = makeShape(shapes[key][s].s);
   }
}

function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
}

function nextShape()
{
   shp = getRandomInt(0, Object.keys(shapes).length);
   r = getRandomInt(0, shapes[Object.keys(shapes)[shp]].length);

   cur = shapes[Object.keys(shapes)[shp]][r].s;
}

function makeShape(shape)
{
   var x=0;
   var y=0;
   var maxX=0;
   for(var c=0; c<shape.length; c++)
   {
     if (shape[c]=='\n') { y++; maxX=Math.max(x, maxX); x=0; } else { x++; }     
   }
   maxX=Math.max(x, maxX);   
   
   var s=new Array(y);
   y=-1; x=0;
   for(var c=0; c<shape.length; c++)
   {
     if (shape[c]=='\n') { 
	x=0; y++; 
        s[y]=new Array(maxX);
     } 
     else {
        if (shape[c]=='*') s[y][x]=shape[c];
        x++;
     }  
   }
   return s;   
}

function initWell() {
   var well = $("#well");
   for(var i=0; i<20; i++)
   {
      var tr=$("<tr/>");
      well.append(tr);
      for(var j=0; j<10; j++)
      {   
        var td = $("<td/>");
        td.addClass("_"+i+"_"+j);
        tr.append(td);
      }
   }
} 

function rotateShape()
{
   var key = Object.keys(shapes)[shp];
   for(var i=1; i<shapes[key].length; i++) {
      var newR=(r+i)%shapes[key].length;
      var newCur=shapes[key][newR].s;
      var org=shapes[key][newR].org;
      if (isValidPos(newCur, { x: pt.x-org.x, y:pt.y-org.y })) {
         paintShape(false);
         cur=newCur;   
         r=newR;
         paintShape(true);
         break;   
      }
   }
}

function isValidPos(shape, pt)
{
   if (pt.x<0 || pt.x+shape[0].length>10) return false;
   if (pt.y+shape.length>20) return false;

   for(var y=0; y<shape.length; y++) {
     for(var x=0; x<shape[y].length; x++) {
        var cell = getCell(pt.x+x,pt.y+y);
	if (shape[y][x]=='*' && cell.hasClass("nonempty") && !cell.hasClass("shape")) return false;
     }
   }
   return true;
}

function changeShape()
{
   paintShape(false);
   shp=(shp+1)%Object.keys(shapes).length;
   r=0;
   var key = Object.keys(shapes)[shp];
   cur=shapes[key][r].s;
   paintShape(true);  
}

$("#well").keydown(function(event) {
	switch(event.originalEvent.code)
        {
           case "ArrowRight": {
		event.preventDefault();
                moveShape(1,0);break;
	   }
           case "ArrowLeft": {
		event.preventDefault();
		moveShape(-1,0);break;
	   }
           case "ArrowUp": {
		event.preventDefault();
                rotateShape();break;
	   }
           case "ArrowDown": {
		event.preventDefault();
                playGame();    
                break;
	   }
           case "Space": {    
		event.preventDefault();
		dropShape();
                break;
           }
        }
});

$("#left").click(function() { moveShape(-1,0); });
$("#right").click(function() { moveShape(1,0); });
$("#rotate").click(function() { rotateShape(); });
$("#drop").click(function() { dropShape(); });
$("#again").click(function() { $(this).hide(); reset(); });

var inPlay=false;
function playGame()
{
    if (inPlay) return;
    inPlay = true;
    if (!moveShape(0,1)) {                   
        if (pt.y<0)
        {
           clearInterval(timer);
           inPlay = false;
           showResetButton();
           return;
        }
        dropShape();
    };                
    inPlay = false;   
}

function releaseShape()
{
    var key = Object.keys(shapes)[shp];
    var org = shapes[key][r].org;
    pt.x=Math.floor((10-cur[0].length) / 2)+org.x;
    pt.y=-cur.length;                      
}

function dropShape()
{
        while(moveShape(0,1));
        embedShape();
        removeLines();
    	var oldTimer = timer;
    	timer = setInterval(playGame, spd);
    	clearInterval(oldTimer);
        nextShape();
        releaseShape();
        paintShape(true);
}

function showResetButton()
{
   $("#again button").text("Score: "+score+". Try Again!");
   $("#again").show();
}

function getCell(x,y)
{          
   var name = "#well ._"+Number(y)+"_"+Number(x);
   var result = $(name);
   return result;
}

function embedShape()
{
    $("#well .shape").removeClass("shape");
}

function moveShape(dx,dy)
{
   var key = Object.keys(shapes)[shp];
   var org = shapes[key][r].org;
   if (!isValidPos(cur, { x: (pt.x+dx)-org.x, y: (pt.y+dy)-org.y })) return false;
   paintShape(false);
   pt.x+=dx;
   pt.y+=dy;
   paintShape(true);
   return true;
}

function removeLines()
{  
   var ctLines = 0;
   var key = Object.keys(shapes)[shp];
   var org = shapes[key][r].org;
   for(var yy=pt.y+cur.length-1-org.y;yy>=0;yy--)
   {
      var line = getCell(0, yy).closest("tr").find("td");
      var blocks=line.closest(".nonempty").length;
      if (blocks==0) break; 
      if (blocks==10)
      {
         ctLines++;
         var lineAbove;
         for(var y=yy;y>0; y--)
         {
            var lineAbove = getCell(0, y-1).closest("tr").find("td");                  
  	    var blanks = blocks-lineAbove.closest(".nonempty").length;
            for(var c=0; c<10; c++) {
              if ($(lineAbove[c]).hasClass("nonempty")) {
                 $(line[c]).addClass("nonempty");              
                 $(line[c]).attr("data-color",$(lineAbove[c]).data("color"));              
              }
              else {                 
                 $(line[c]).removeClass("nonempty"); 
                 $(line[c]).attr("data-color","");              
              }           
            }
            line=lineAbove;
            if (blanks==blocks) break;
         }
         yy++; 
      }
   }
   if (ctLines==4) ctLines*=2;
   score += 10*ctLines;  
}

function paintShape(on)
{
   var key = Object.keys(shapes)[shp];
   var org = shapes[key][r].org;
   for(var y=0; y< cur.length; y++)
     for(var x=0; x< cur[y].length; x++) 
	if (cur[y][x]=='*') {
	    var cell = getCell((pt.x+x)-org.x,(pt.y+y)-org.y) 
	    if (on) cell.addClass("nonempty").addClass("shape").attr("data-color",key); 
		else cell.removeClass("nonempty").removeClass("shape").attr("data-color","");
        }
}

function reset()
{
    clearInterval(timer);
    $("#well .nonempty").removeClass("nonempty").removeClass("shape");
    score = 0;
    nextShape();
    releaseShape();
    spd = 800;    
    timer = setInterval(playGame, spd);                                   
    $("#well").focus();
    
}

makeShapes();
initWell();
nextShape();
paintShape(true);
reset();
setInterval(function() {
    spd=Math.max(0,spd-80);
}, 60000);
</script>

</body>
</html>